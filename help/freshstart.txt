# freshstart.txt
# ===========================
# Kidspot Pi + DAC + Raspotify Setup Guide
# This file contains instructions and explanations for setting up your Raspberry Pi,
# ensuring the DAC is used, Raspotify is configured, and Kidspot can operate correctly.
# Comments (lines starting with #) explain the reasoning and context.

# -----------------------------------
# 1️⃣ Install and configure DAC
# -----------------------------------
# Step 1: Connect your DAC HAT to the Pi (I2S or GPIO pins as required).

# Step 2: Verify the Pi detects the DAC
# Command:
aplay -l
# Expected outcome: You should see your DAC listed as a playback device.
# Note the card number (e.g., card 1) and device number (e.g., device 0) for configuration.

# Step 3: Set the DAC as the default ALSA device
# Edit or create the ALSA configuration file:
sudo nano /etc/asound.conf
# Add the following (replace card/device numbers with your DAC values):
pcm.!default {
  type hw
  card 1       # replace with your DAC card number
  device 0     # replace with your DAC device number
}

ctl.!default {
  type hw
  card 1
}

# Step 4: Test the DAC output
aplay /usr/share/sounds/alsa/Front_Center.wav
# Expected: a test tone plays through the DAC.

# -----------------------------------
# 2️⃣ Install Raspotify
# -----------------------------------
# Raspotify is the Spotify Connect client which will receive playback commands from Kidspot.

# Step 1: Install Raspotify
curl -sL https://dtcooper.github.io/raspotify/install.sh | sh

# Step 2: Configure Raspotify to use your DAC
sudo nano /etc/default/raspotify
# Ensure the following settings (replace hw:1,0 with your DAC card/device):
DEVICE_NAME="MyRaspotifyDevice"  # Must match the .env DEVICE_NAME
DEVICE="hw:1,0"                   # ALSA device for the DAC

# Step 3: Restart Raspotify to apply changes
sudo systemctl restart raspotify

# Step 4: Verify Raspotify is running
systemctl status raspotify
# Expected: active (running)
# From your Spotify client, you should see "MyRaspotifyDevice" as a Connect target.

# -----------------------------------
# 3️⃣ Volume control considerations
# -----------------------------------
# Spotify API volume control (via spot.py) adjusts software volume only.
# DAC hardware volume is independent. Typically:
# - Keep DAC hardware at a fixed level.
# - Use spot.py volume commands for playback adjustments.

# -----------------------------------
# 4️⃣ Kidspot integration
# -----------------------------------
# Kidspot scripts do not need any DAC-specific code.
# Key points:
# - Ensure .env DEVICE_NAME matches Raspotify DEVICE_NAME
# - spot.py play/pause/volume calls are automatically routed through Raspotify → ALSA → DAC

# -----------------------------------
# 5️⃣ Optional checks
# -----------------------------------
# Before running Kidspot:
# - Test Raspotify playback to confirm audio reaches DAC
# - Ensure ALSA default device persists across reboots
# - Confirm Kidspot .env and swipe.json are correctly set

# -----------------------------------
# 6️⃣ Notes / reasoning
# -----------------------------------
# - Kidspot scripts do not handle audio routing; this is managed by the OS and Raspotify
# - DAC integration is effectively “transparent” to Python code
# - Spotify availability is treated as a recoverable degraded state, not fatal
# - LEDs can signal issues (raspotify unavailable, unknown RFID swipe)
# - Clean shutdown ensures spot.py pauses playback and LEDs are turned off
